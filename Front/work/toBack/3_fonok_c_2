// works only with ascii chars
#include <cctype>
#include <cstdio>
#include <cstring>
#include <algorithm>
using namespace std;

typedef char* charp;

char abc[]="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_:;[]()";
const int nabc=strlen(abc);
char salt[]="titkosjelszoTITKOSJELSZOsecretpasswordSECRETPASSWORDconfidentalCONFIDENTALblahblahblah";
const int nsalt=strlen(salt);


charp hash(charp a){
  static char h[1024];
  int na=strlen(a);
  int i=0,j=0;
  int m=max(na,nsalt);
  int k=0;
  while(k<m){
    h[k]=abc[(salt[i]*a[j]+128+i*i+j*j)%nabc];
    k=k+1;
    j+=1;
    if(j>=na){
      j=0;
    }
    i+=1;
    if(i>=nsalt){
      i=0;
    }
  }
  h[m]=0;
  return h;
}

int query(charp user,charp pwd,const bool add=false){
  FILE* f=nullptr;
  if(true==add){
    f=fopen("db","a+");
  }else{
    f=fopen("db","r");
  }
  char a[1024],b[1024];
  int ans=0;
  while(2==fscanf(f,"%s%s",a,b)){
    if(!strcmp(a,user)){
      ans=2;
      break;
    }
  }
  if(2==ans){
    ans=ans+((0==strcmp(b,pwd))?1:0);
  }

  if(true==add && 0==ans){
    fprintf(f,"%s %s\n",user,pwd);
  }

  fclose(f);
  return ans;
}

bool modify(charp user,charp pwd,const bool del=false){//assuming user exists
  FILE* f=fopen("db","r");
  FILE* f_=fopen("db_","w+");

  char a[1024],b[1024];
  while(2==fscanf(f,"%s%s",a,b)){
    if(strcmp(a,user)){
      fprintf(f_,"%s %s\n",a,b);
    }else{
      break;
    }
  }
  if(false==del){
    fprintf(f_,"%s %s\n",user,pwd);
  }
  while(2==fscanf(f,"%s%s",a,b)){
    fprintf(f_,"%s %s\n",a,b);
  }
  fclose(f);
  fclose(f_);
  return 0==rename("db_","db");
}

int main(int npar, char** par){
  if(npar<4){
    return 0;
  }

  charp
    cmd,user,pwd;

  cmd=par[1];
  user=par[2];
  pwd=hash(par[3]);

  while(1){
    if(!strcmp(cmd,"add")){
      if(0==query(user,pwd,true)){
        printf("OK\n");
      }else{
        printf("FAIL\n");
      }
      break;
    }


    if(!strcmp(cmd,"query")){
      if(3==query(user,pwd)){ //2*(user:0,1)+pwd(0,1)
        printf("OK\n");
      }else{
        printf("FAIL\n");
      }
      break;
    }

    if(!strcmp(cmd,"modify")){
      if(true==modify(user,pwd)){ 
        printf("OK\n");
      }else{
        printf("FAIL\n");
      }
      break;
    }

    if(!strcmp(cmd,"delete")){
      if(true==modify(user,pwd,true)){
        printf("OK\n");
      }else{
        printf("FAIL\n");
      }
      break;
    }
  }

  return 0;
}
